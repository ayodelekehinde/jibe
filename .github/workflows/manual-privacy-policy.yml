name: Publish Privacy Policy to GitHub Pages

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Prepare Site
        run: |
          mkdir -p public/privacy-policy
          
          # Create python script to convert MD to HTML with Styles
          cat <<EOF > convert.py
          import re
          
          css = """
          <style>
              :root {
                  --primary-color: #2c3e50;
                  --text-color: #333;
                  --bg-color: #f9f9f9;
                  --card-bg: #ffffff;
              }
              body {
                  font-family: 'Segoe UI', SYSTEM-UI, -apple-system, sans-serif;
                  line-height: 1.5;
                  color: var(--text-color);
                  background-color: var(--bg-color);
                  max-width: 800px;
                  margin: 0 auto;
                  padding: 20px 15px;
              }
              .container {
                  background: var(--card-bg);
                  padding: 30px;
                  border-radius: 8px;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
              }
              h1 {
                  color: var(--primary-color);
                  border-bottom: 2px solid #eaeaea;
                  padding-bottom: 8px;
                  margin-top: 0;
                  margin-bottom: 20px;
                  font-size: 1.8em;
              }
              h2 {
                  color: var(--primary-color);
                  margin-top: 24px;
                  margin-bottom: 12px;
                  font-size: 1.4em;
              }
              h3 {
                  color: var(--text-color);
                  margin-top: 20px;
                  margin-bottom: 8px;
                  font-size: 1.1em;
              }
              p {
                margin-bottom: 12px;
              }
              ul {
                  padding-left: 20px;
                  margin-bottom: 12px;
              }
              li {
                  margin-bottom: 4px;
              }
              strong {
                  color: #000;
                  font-weight: 600;
              }
              .footer {
                  margin-top: 30px;
                  text-align: center;
                  font-size: 0.85em;
                  color: #888;
              }
          </style>
          """
          
          html_start = f"""
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Jibe Privacy Policy</title>
              {css}
          </head>
          <body>
              <div class="container">
          """
          
          html_end = """
              </div>
              <div class="footer">
                  <p>&copy; 2025 Jibe Project. Open Source.</p>
              </div>
          </body>
          </html>
          """
          
          with open("PRIVACY_POLICY.md", "r") as f:
              lines = f.readlines()
              
          content = ""
          in_list = False
          
          for line in lines:
              line = line.strip()
              
              # Basic MD parsing
              
              # Headers
              if line.startswith("# "):
                  if in_list: content += "</ul>\\n"; in_list = False
                  content += f"<h1>{line[2:]}</h1>\\n"
              elif line.startswith("## "):
                  if in_list: content += "</ul>\\n"; in_list = False
                  content += f"<h2>{line[3:]}</h2>\\n"
              elif line.startswith("### "):
                  if in_list: content += "</ul>\\n"; in_list = False
                  content += f"<h3>{line[4:]}</h3>\\n"
              elif line.startswith("- "):
                  if not in_list: content += "<ul>\\n"; in_list = True
                  # Handle bold in lists if needed, but generic line processing handles it below
                  clean_line = line[2:]
                  # Simple bold replacement **text** -> <strong>text</strong>
                  clean_line = re.sub(r'\*\*(.*?)\*\*', r'<strong>\1</strong>', clean_line)
                  content += f"<li>{clean_line}</li>\\n"
              elif line == "":
                  if in_list: content += "</ul>\\n"; in_list = False
                  content += "<br>\\n"
              else:
                  if in_list: content += "</ul>\\n"; in_list = False
                  clean_line = re.sub(r'\*\*(.*?)\*\*', r'<strong>\1</strong>', line)
                  content += f"<p>{clean_line}</p>\\n"
                  
          if in_list: content += "</ul>\\n"
          
          final_html = html_start + content + html_end
          
          with open("public/privacy-policy/index.html", "w") as f:
              f.write(final_html)
              
          print("Converted successfully.")
          EOF
          
          python3 convert.py
          
          # 2. Create Root Redirect
          echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0; url=./privacy-policy/" /></head><body>Redirecting...</body></html>' > public/index.html
          
          # 3. Disable Jekyll
          touch public/.nojekyll

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
